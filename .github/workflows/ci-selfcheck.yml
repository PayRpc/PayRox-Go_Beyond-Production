name: CI Selfcheck

on:
  push:
    branches: [main, release/**]
    tags: [v*]
  workflow_dispatch:

jobs:
  selfcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - run: npm run pipeline:predictive
      - run: npm run pipeline:observed || true

  sign-manifest:
    if: ${{ (github.ref == 'refs/heads/main' || startsWith(github.ref,'refs/heads/release/') || startsWith(github.ref,'refs/tags/v')) && secrets.SIGNER_KEY != '' && secrets.DISPATCHER_ADDR != '' }}
    needs: [selfcheck]
    runs-on: ubuntu-latest
    env:
      SIGNER_KEY: ${{ secrets.SIGNER_KEY }}
      DISPATCHER_ADDR: ${{ secrets.DISPATCHER_ADDR }}
      CHAIN_ID: ${{ vars.CHAIN_ID || '1' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci

      - name: Ensure manifest.root.json exists
        run: |
          if [ ! -f split-output/manifest.root.json ]; then
            npm run pipeline:predictive
          fi

      - name: Sign manifest (EIP-712)
        run: npx hardhat payrox:manifest:sign \
          --path split-output/manifest.root.json \
          --dispatcher "$DISPATCHER_ADDR" \
          --key "$SIGNER_KEY" \
          --chain-id "$CHAIN_ID" \
          --json

      - name: Verify signature
        run: npx hardhat payrox:manifest:verify \
          --path split-output/manifest.root.json \
          --dispatcher "$DISPATCHER_ADDR" \
          --json

      - name: Auto codehash diff (latest snapshots)
        run: npm run pipeline:diff
